name: Release Skills

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  package-skills:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Package skills
        run: |
          mkdir -p dist
          cd skills
          for skill in */; do
            skill_name=$(basename "$skill")
            version=$(sed -n 's/^  version: *"\{0,1\}\([^"]*\)"\{0,1\}/\1/p' "$skill/SKILL.md" | head -1)
            if [ -z "$version" ]; then
              echo "WARNING: No version found for $skill_name, skipping"
              continue
            fi
            tar czf "../dist/${skill_name}-${version}.tar.gz" "$skill"
          done

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/*.tar.gz
          generate_release_notes: true

  publish-tiles:
    runs-on: ubuntu-latest
    needs: package-skills
    steps:
      - uses: actions/checkout@v6

      - name: Install tessl CLI
        run: curl -fsSL https://get.tessl.io | sh

      - name: Regenerate tile.json files
        run: |
          for d in skills/*/; do
            [ -f "$d/tile.json" ] && tessl skill import "$d" --workspace odyssey4me --public --force 2>/dev/null
          done

      - name: Verify tiles are in sync
        run: git diff --exit-code skills/*/tile.json

      - name: Publish skills to Tessl Registry
        env:
          TESSL_API_KEY: ${{ secrets.TESSL_API_KEY }}
        run: |
          for d in skills/*/; do
            if [ -f "$d/tile.json" ]; then
              echo "=== Publishing $d ==="
              tessl skill publish "$d" --public
            fi
          done
