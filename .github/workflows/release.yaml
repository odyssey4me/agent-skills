name: Release Skills

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

jobs:
  package-skills:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Package skills
        run: |
          mkdir -p dist
          cd skills
          for skill in */; do
            skill_name=$(basename "$skill")
            version=$(sed -n 's/^  version: *"\{0,1\}\([^"]*\)"\{0,1\}/\1/p' "$skill/SKILL.md" | head -1)
            if [ -z "$version" ]; then
              echo "WARNING: No version found for $skill_name, skipping"
              continue
            fi
            tar czf "../dist/${skill_name}-${version}.tar.gz" "$skill"
          done

      - name: Upload assets to release
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh release upload "${{ github.ref_name }}" dist/*.tar.gz --clobber

  discover-skills:
    runs-on: ubuntu-latest
    outputs:
      skills: ${{ steps.find.outputs.skills }}
    steps:
      - uses: actions/checkout@v6

      - name: Find publishable skills
        id: find
        run: |
          skills=$(ls -d skills/*/tile.json 2>/dev/null | xargs -I{} dirname {} | jq -R -s -c 'split("\n") | map(select(. != ""))')
          echo "skills=$skills" >> "$GITHUB_OUTPUT"

  publish-tiles:
    runs-on: ubuntu-latest
    needs: [package-skills, discover-skills]
    if: needs.discover-skills.outputs.skills != '[]'
    strategy:
      matrix:
        skill: ${{ fromJson(needs.discover-skills.outputs.skills) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v6

      - name: Publish ${{ matrix.skill }}
        uses: tesslio/publish@main
        with:
          path: ${{ matrix.skill }}
          token: ${{ secrets.TESSL_API_TOKEN }}
          review: 'false'
