# See https://pre-commit.com for more information
# See https://pre-commit.com/hooks.html for more hooks
repos:
  # Ruff - Fast Python linter and formatter
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.14.13
    hooks:
      # Run the linter
      - id: ruff
        name: ruff lint
        args: [--fix]
        stages: [pre-commit]
      # Run the formatter
      - id: ruff-format
        name: ruff format
        stages: [pre-commit]
      # Pre-push: strict checks matching CI (no auto-fix)
      - id: ruff
        name: ruff check (pre-push)
        alias: ruff-check-prepush
        stages: [pre-push]
      - id: ruff-format
        name: ruff format check (pre-push)
        alias: ruff-format-prepush
        args: [--check]
        stages: [pre-push]

  # Validate skill structure before commit
  - repo: local
    hooks:
      - id: validate-skills
        name: validate skill structure
        entry: python scripts/validate_skill.py
        language: system
        files: ^skills/.*/SKILL\.md$
        pass_filenames: false
        args: [skills/*]
        stages: [pre-commit]

      - id: tessl-lint
        name: tessl skill lint
        entry: bash -c 'status=0; for t in skills/*/tile.json; do tessl skill lint "$t" || status=1; done; exit $status'
        language: system
        files: ^skills/
        pass_filenames: false
        stages: [pre-commit]

      - id: tessl-sync
        name: check tile.json files are up to date
        entry: bash -c 'for d in skills/*/; do [ -f "$d/tile.json" ] && tessl skill import "$d" --workspace odyssey4me --public --force 2>/dev/null; done; git diff --exit-code skills/*/tile.json'
        language: system
        files: ^skills/
        pass_filenames: false
        stages: [pre-commit]

      - id: diff-cover
        name: coverage for changed lines
        entry: bash -c 'pytest tests/ -q --cov=skills --cov=scripts --cov-report=xml:coverage.xml && diff-cover coverage.xml --compare-branch=HEAD --fail-under=80'
        language: system
        pass_filenames: false
        types: [python]
        stages: [pre-commit]

  # Run full CI checks before push
  - repo: local
    hooks:
      - id: validate-skills-prepush
        name: validate skill structure (pre-push)
        entry: python scripts/validate_skill.py
        language: system
        pass_filenames: false
        args: [skills/*]
        stages: [pre-push]
        always_run: true

      - id: tessl-lint-prepush
        name: tessl skill lint (pre-push)
        entry: bash -c 'status=0; for t in skills/*/tile.json; do tessl skill lint "$t" || status=1; done; exit $status'
        language: system
        pass_filenames: false
        stages: [pre-push]
        always_run: true

      - id: tessl-sync-prepush
        name: check tile.json files are up to date (pre-push)
        entry: bash -c 'for d in skills/*/; do [ -f "$d/tile.json" ] && tessl skill import "$d" --workspace odyssey4me --public --force 2>/dev/null; done; git diff --exit-code skills/*/tile.json'
        language: system
        pass_filenames: false
        stages: [pre-push]
        always_run: true

      - id: pytest-coverage
        name: pytest (full test suite with coverage)
        entry: pytest
        language: system
        pass_filenames: false
        args: [tests/, -v, --cov=skills, --cov=scripts, --cov-report=term-missing, --cov-fail-under=80]
        stages: [pre-push]
        always_run: true


# Default stages (can be overridden per hook)
default_stages: [pre-commit]

# Fail fast - stop on first failure
fail_fast: false
